package service

import (
	"context"
	"dove/internal/domain"
	"dove/internal/model"
	"dove/pkg/logger"
	"dove/pkg/pagination"
)

type {{.Name | lower}}Service struct {
	repo domain.{{.Name}}Repository
}

func New{{.Name}}Service(repo domain.{{.Name}}Repository) domain.{{.Name}}Service {
	return &{{.Name | lower}}Service{repo: repo}
}

func (s *{{.Name | lower}}Service) Create(ctx context.Context, {{.Name | lower}} *model.{{.Name}}) error {
	if err := s.repo.Create(ctx, {{.Name | lower}}); err != nil {
		logger.ErrorWithTrace(ctx, "Failed to create {{.Name | lower}}", "error", err.Error())
		return err
	}

	logger.InfoWithTrace(ctx, "{{.Name}} created successfully", "{{.Name | lower}}_id", {{.Name | lower}}.ID)
	return nil
}

func (s *{{.Name | lower}}Service) GetByID(ctx context.Context, id uint) (*model.{{.Name}}, error) {
	{{.Name | lower}}, err := s.repo.GetByID(ctx, id)
	if err != nil {
		logger.ErrorWithTrace(ctx, "Failed to get {{.Name | lower}} by ID", "error", err.Error(), "{{.Name | lower}}_id", id)
		return nil, err
	}
	logger.InfoWithTrace(ctx, "{{.Name}} retrieved by ID", "{{.Name | lower}}_id", id)
	return {{.Name | lower}}, nil
}

func (s *{{.Name | lower}}Service) GetAll(ctx context.Context) ([]model.{{.Name}}, error) {
	{{.Name | lower}}s, err := s.repo.GetAll(ctx)
	if err != nil {
		logger.ErrorWithTrace(ctx, "Failed to get all {{.Name | lower}}s", "error", err.Error())
		return nil, err
	}
	logger.InfoWithTrace(ctx, "All {{.Name | lower}}s retrieved", "count", len({{.Name | lower}}s))
	return {{.Name | lower}}s, nil
}

func (s *{{.Name | lower}}Service) GetAllWithPagination(ctx context.Context, page *pagination.PageRequest) (*pagination.PageResponse, error) {
	{{.Name | lower}}s, total, err := s.repo.GetAllWithPagination(ctx, page)
	if err != nil {
		logger.ErrorWithTrace(ctx, "Failed to get {{.Name | lower}}s with pagination", "error", err.Error(), "page", page.Page, "pageSize", page.PageSize)
		return nil, err
	}
	
	pageResponse := pagination.NewPageResponse({{.Name | lower}}s, total, page.Page, page.PageSize)
	logger.InfoWithTrace(ctx, "{{.Name}}s retrieved with pagination", "count", len({{.Name | lower}}s), "total", total, "page", page.Page, "pageSize", page.PageSize)
	return pageResponse, nil
}

func (s *{{.Name | lower}}Service) Update(ctx context.Context, {{.Name | lower}} *model.{{.Name}}) error {
	// 检查是否存在
	_, err := s.repo.GetByID(ctx, {{.Name | lower}}.ID)
	if err != nil {
		logger.ErrorWithTrace(ctx, "Failed to get existing {{.Name | lower}} for update", "error", err.Error(), "{{.Name | lower}}_id", {{.Name | lower}}.ID)
		return err
	}

	if err := s.repo.Update(ctx, {{.Name | lower}}); err != nil {
		logger.ErrorWithTrace(ctx, "Failed to update {{.Name | lower}}", "error", err.Error(), "{{.Name | lower}}_id", {{.Name | lower}}.ID)
		return err
	}

	logger.InfoWithTrace(ctx, "{{.Name}} updated successfully", "{{.Name | lower}}_id", {{.Name | lower}}.ID)
	return nil
}

func (s *{{.Name | lower}}Service) Delete(ctx context.Context, id uint) error {
	// 检查是否存在
	if _, err := s.repo.GetByID(ctx, id); err != nil {
		logger.ErrorWithTrace(ctx, "Failed to get {{.Name | lower}} for deletion", "error", err.Error(), "{{.Name | lower}}_id", id)
		return err
	}

	if err := s.repo.Delete(ctx, id); err != nil {
		logger.ErrorWithTrace(ctx, "Failed to delete {{.Name | lower}}", "error", err.Error(), "{{.Name | lower}}_id", id)
		return err
	}
	logger.InfoWithTrace(ctx, "{{.Name}} deleted successfully", "{{.Name | lower}}_id", id)
	return nil
}
